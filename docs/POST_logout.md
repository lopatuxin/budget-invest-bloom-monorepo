# Backend Specification - POST logout

## Общее описание

Endpoint для выхода пользователя из системы ведения личных финансов. Позволяет аутентифицированным пользователям безопасно завершить текущую сессию, отзывая JWT токены и очищая данные сессии. Поддерживает как выход из текущей сессии, так и принудительный выход со всех устройств для повышенной безопасности.

**Важно**: Endpoint требует валидный access token в заголовке Authorization для идентификации пользователя и сессии.

## Endpoint

```
POST /api/auth/logout
```

## Структура запроса

Запрос использует **стандартный формат API** (подробнее в [standartRequestAndResponse.md](standartRequestAndResponse.md)) и требует аутентификации через JWT токен.

| Поле   | Тип    | Обязательное | Описание                                                     |
|--------|--------|--------------|--------------------------------------------------------------|
| `user` | object | Нет          | Контекст пользователя (заполняется автоматически из JWT)    |
| `data` | object | Да           | Данные для выхода из системы                                 |

### Блок `data` - параметры выхода

| Параметр        | Тип     | Обязательный | Описание                                                   |
|-----------------|---------|--------------|-----------------------------------------------------------|
| `logoutFromAll` | boolean | Нет          | Завершить все активные сессии (по умолчанию: false)       |

### Заголовки запроса

| Заголовок          | Обязательный | Описание                                        |
|--------------------|--------------|------------------------------------------------|
| `Authorization`    | Да           | Bearer access token для идентификации пользователя |

### Пример запроса

**Выход из текущей сессии:**
```json
{
  "user": null,
  "data": {
    "logoutFromAll": false
  }
}
```

**Выход со всех устройств:**
```json
{
  "user": null,
  "data": {
    "logoutFromAll": true
  }
}
```

**HTTP Headers:**
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## Логика обработки

1. **Валидация access token**:
    - Извлечение JWT токена из заголовка `Authorization`
    - Проверка подписи и срока действия access token
    - Извлечение `userId` и `sessionId` из токена
    - Если токен недействителен, возвращается ошибка `401 Unauthorized`

2. **Определение refresh token**:
    - Если `X-Refresh-Token` передан в заголовке запроса, используется он
    - Если refresh token не найден, процесс продолжается (защита от повторных вызовов)

3. **Отзыв токенов**:
    - Добавление access token в blacklist Redis с TTL до истечения срока действия
    - Добавление refresh token в blacklist Redis (если найден)
    - Удаление записи сессии из Redis cache

4. **Обработка режима logout from all**:
    - Если `logoutFromAll = true`, поиск всех активных сессий пользователя
    - Отзыв всех access и refresh токенов пользователя
    - Очистка всех записей сессий из Redis cache
    - Увеличение версии безопасности пользователя в БД

5. **Обновление данных пользователя**:
    - Обновление поля `last_logout_at` в таблице `user`
    - Сохранение информации о завершении сессии
    - Если `logoutFromAll = true`, обновление `security_version`

6. **Логирование и аудит**:
    - Запись информации о завершении сессии в журнал аудита
    - Сохранение IP адреса, User-Agent и типа logout
    - Отправка события в Kafka для аналитики

7. **Уведомления о безопасности**:
    - При `logoutFromAll = true` отправка уведомлений на все устройства
    - Email уведомление о завершении всех сессий

## Структура ответа

Ответ использует **стандартный формат API** (подробнее в [standartRequestAndResponse.md](standartRequestAndResponse.md)):

| Поле        | Тип     | Описание                                                      |
|-------------|---------|---------------------------------------------------------------|
| `id`        | string  | Уникальный идентификатор запроса в формате UUID               |
| `status`    | number  | HTTP статус код ответа (200)                                  |
| `message`   | string  | Сообщение об успешном завершении сессии                       |
| `timestamp` | string  | Временная метка формирования ответа в ISO 8601 UTC формате    |
| `body`      | object  | Объект с данными о завершенных сессиях                        |

### Блок `body` - информация о logout

| Поле        | Тип    | Описание                                      |
|-------------|--------|-----------------------------------------------|
| `message`   | string | Сообщение об успешном завершении сессии       |
| `loggedOut` | number | Количество завершенных сессий                 |
| `timestamp` | string | Время завершения сессии в ISO 8601 формате    |

### Пример успешного ответа

**Выход из текущей сессии:**
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "status": 200,
  "message": "Вы успешно вышли из системы",
  "timestamp": "2025-08-07T12:30:45.123Z",
  "body": {
    "message": "Вы успешно вышли из системы",
    "loggedOut": 1,
    "timestamp": "2025-08-07T12:30:45.123Z"
  }
}
```

**Выход со всех устройств:**
```json
{
  "id": "456e7890-e89b-12d3-a456-426614174000",
  "status": 200,
  "message": "Вы успешно вышли из системы на всех устройствах",
  "timestamp": "2025-08-07T12:30:45.234Z",
  "body": {
    "message": "Вы успешно вышли из системы на всех устройствах",
    "loggedOut": 3,
    "timestamp": "2025-08-07T12:30:45.234Z"
  }
}
```

## Коды состояния

| Код | Сообщение             | Описание                                                         |
|-----|-----------------------|------------------------------------------------------------------|
| 200 | OK                    | Успешное завершение сессии                                       |
| 400 | Bad Request           | Некорректные данные запроса                                      |
| 401 | Unauthorized          | Отсутствует или недействителен access token                      |
| 403 | Forbidden             | Токен отозван или заблокирован                                   |
| 422 | Unprocessable Entity  | Ошибки валидации refresh token                                   |
| 500 | Internal Server Error | Внутренняя ошибка сервера при завершении сессии                  |

### Примеры ошибок

**401 Unauthorized - отсутствует токен:**
```json
{
  "error": "MISSING_TOKEN",
  "message": "Требуется access token в заголовке Authorization",
  "timestamp": "2025-08-07T12:30:45.123Z"
}
```

**401 Unauthorized - недействительный токен:**
```json
{
  "error": "INVALID_TOKEN",
  "message": "Access token недействителен или истек",
  "timestamp": "2025-08-07T12:30:45.123Z"
}
```

**403 Forbidden - токен в blacklist:**
```json
{
  "error": "TOKEN_REVOKED",
  "message": "Токен был отозван",
  "timestamp": "2025-08-07T12:30:45.123Z"
}
```

**400 Bad Request - неверный refresh token:**
```json
{
  "error": "INVALID_REFRESH_TOKEN",
  "message": "Переданный refresh token имеет неверный формат",
  "timestamp": "2025-08-07T12:30:45.123Z"
}
```

## Безопасность и ограничения

### Защита от атак
- **Token Blacklisting**: немедленная инвалидация отозванных токенов
- **Session Management**: надежное удаление сессионных данных
- **Audit Trail**: полное логирование всех операций выхода
- **Idempotency**: безопасная обработка повторных вызовов logout

### Управление сессиями
- **Graceful Logout**: корректное завершение активных операций
- **Multi-device Support**: возможность выхода с конкретного устройства
- **Force Logout**: принудительное завершение всех сессий
- **Session Cleanup**: автоматическая очистка истекших сессий

### Временные ограничения
- Access токены остаются в blacklist до истечения их TTL
- Refresh токены инвалидируются немедленно
- Сессионные данные удаляются из Redis в течение 1 секунды
- Аудит записи сохраняются в течение 90 дней

### Производительность
- **Redis Pipelining**: батчевые операции для множественного logout
- **Async Processing**: асинхронная отправка уведомлений
- **Cache Optimization**: эффективное управление blacklist токенов

## Интеграция с другими компонентами

### База данных
- Обновление поля `last_logout_at` в таблице `user`
- Увеличение `security_version` при logout from all
- Запись в таблицу `audit_log` для безопасности

### Кэширование (Redis)
- Добавление токенов в blacklist с TTL
- Удаление сессионных данных
- Очистка cached данных пользователя

### API Gateway
- Проверка blacklist токенов при последующих запросах
- Автоматическое перенаправление на login при 401 ошибках

### Notification Service
- Отправка push уведомлений на все устройства при force logout
- Email уведомления о завершении сессий
- SMS алерты при подозрительной активности

### Зависимости
- **JWT Library**: для валидации и парсинга токенов
- **Redis**: для blacklist и управления сессиями
- **PostgreSQL**: для обновления пользовательских данных
- **Kafka**: для отправки событий аудита

### Связь с другими API
После logout пользователь должен:
- Повторно аутентифицироваться через [POST /api/login](POST_login.md)
- Получить новые токены для доступа к защищенным ресурсам
- Использовать `POST /api/auth/refresh` только с новыми токенами

## События и уведомления

### Kafka Events
При успешном logout отправляются события:
- `user.logged_out`: информация о завершении сессии
- `security.session_terminated`: данные для аудита безопасности
- `user.force_logout`: при завершении всех сессий (если `logoutFromAll = true`)

### Уведомления пользователя
- Push уведомление о завершении сессии на текущем устройстве
- Email уведомление при force logout со всех устройств
- SMS алерт при подозрительной активности (множественные force logout)

### Аналитика
- Метрики времени активной сессии
- Статистика использования logout from all
- Аналитика паттернов завершения сессий

## Тестирование

### Позитивные сценарии
- Успешный logout с валидным access token
- Logout с передачей refresh token в заголовке X-Refresh-Token
- Force logout со всех устройств
- Повторный вызов logout (idempotency)
- Logout с истекшим refresh token (но валидным access)

### Негативные сценарии
- Попытка logout без access token
- Logout с недействительным access token
- Logout с отозванным токеном
- Logout с неверным форматом refresh token
- Обработка ошибок Redis и базы данных

### Безопасность
- Проверка корректного добавления токенов в blacklist
- Тестирование защиты от replay атак
- Валидация очистки сессионных данных
- Проверка аудита всех операций logout

### Нагрузочное тестирование
- Множественные одновременные logout операции
- Force logout с большим количеством активных сессий
- Производительность операций с Redis blacklist
- Стабильность при высокой нагрузке logout запросов

### Интеграционное тестирование
- Проверка отправки Kafka событий
- Интеграция с Notification Service
- Тестирование с API Gateway blacklist проверками
- Проверка обновления данных в PostgreSQL