# Backend Specification - POST register

## Общее описание

Endpoint для создания новых пользовательских аккаунтов в системе ведения личных финансов. Позволяет пользователям
зарегистрироваться в системе используя email адрес и пароль. После успешной регистрации создается новый аккаунт
пользователя с базовой ролью `USER`. Для входа в систему после регистрации пользователь должен использовать отдельную
ручку аутентификации.

## Endpoint

```
POST /api/register
```

## Структура запроса

Запрос использует **стандартный формат API** (подробнее в [standartRequestAndResponse.md](standartRequestAndResponse.md)):

| Поле   | Тип    | Обязательное | Описание                                                     |
|--------|--------|--------------|--------------------------------------------------------------|
| `user` | object | Нет          | Контекст пользователя (null для публичного endpoint)         |
| `data` | object | Да           | Данные для регистрации нового пользователя                   |

### Блок `data` - параметры регистрации

| Параметр    | Тип    | Обязательный | Описание                                 |
|-------------|--------|--------------|------------------------------------------|
| `email`     | string | Да           | Email адрес пользователя (будет логином) |
| `password`  | string | Да           | Пароль для аккаунта (минимум 6 символов) |
| `firstName` | string | Да           | Имя пользователя                         |
| `lastName`  | string | Да           | Фамилия пользователя                     |

### Пример запроса

```json
{
  "user": null,
  "data": {
    "email": "user@example.com",
    "password": "mypassword123",
    "firstName": "Иван",
    "lastName": "Иванов"
  }
}
```

## Логика обработки

1. **Валидация входных данных**:
    - Проверка наличия обязательных полей `email`, `password`, `firstName` и `lastName`
    - Валидация email адреса на соответствие формату RFC 5322
    - Проверка длины пароля (минимум 6 символов)
    - Валидация имени и фамилии (не пустые, максимум 50 символов каждое)
    - Нормализация email адреса (приведение к нижнему регистру, удаление пробелов)
    - Нормализация имени и фамилии (удаление лишних пробелов)

2. **Проверка уникальности**:
    - Проверка, что email адрес не занят другим пользователем
    - В случае дублирования возвращается ошибка `400 Bad Request`

3. **Создание аккаунта**:
    - Генерация уникального UUID для нового пользователя
    - Хеширование пароля с использованием bcrypt (12 раундов)
    - Создание записи в таблице `user` с полями:
        - `id`: сгенерированный UUID
        - `email`: нормализованный email адрес
        - `password_hash`: хеш пароля
        - `first_name`: нормализованное имя
        - `last_name`: нормализованная фамилия
        - `is_active`: `true` (аккаунт сразу активен)
        - `is_verified`: `false` (email не подтвержден)
        - `created_at`: текущее время
        - `updated_at`: текущее время

4. **Назначение роли**:
    - Автоматическое создание записи в таблице `user_role`
    - Назначение базовой роли `USER` новому пользователю

5. **Формирование ответа**:
    - Возврат стандартного ответа API с подтверждением успешной регистрации
    - Статус код 201 (Created)

## Структура ответа

Ответ использует **стандартный формат API** (подробнее в [standartRequestAndResponse.md](standartRequestAndResponse.md)):

| Поле        | Тип     | Описание                                                      |
|-------------|---------|---------------------------------------------------------------|
| `id`        | string  | Уникальный идентификатор запроса в формате UUID               |
| `status`    | number  | HTTP статус код ответа (201)                                  |
| `message`   | string  | Сообщение об успешной регистрации                             |
| `timestamp` | string  | Временная метка формирования ответа в ISO 8601 UTC формате    |
| `body`      | object  | null (данные пользователя не возвращаются в текущей реализации)|

### Пример успешного ответа

```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "status": 201,
  "message": "Пользователь успешно зарегистрирован",
  "timestamp": "2025-08-07T12:30:45.123Z",
  "body": null
}
```

## Коды состояния

| Код | Сообщение             | Описание                                                       |
|-----|-----------------------|----------------------------------------------------------------|
| 201 | Created               | Пользователь успешно зарегистрирован                           |
| 400 | Bad Request           | Некорректные данные запроса или email уже используется         |
| 422 | Unprocessable Entity  | Ошибки валидации (некорректный email, слишком короткий пароль) |
| 429 | Too Many Requests     | Превышен лимит запросов на регистрацию с одного IP             |
| 500 | Internal Server Error | Внутренняя ошибка сервера при создании аккаунта                |

### Примеры ошибок

**400 Bad Request - email уже используется:**

```json
{
  "error": "EMAIL_ALREADY_EXISTS",
  "message": "Пользователь с таким email адресом уже существует",
  "field": "email"
}
```

**422 Unprocessable Entity - некорректный email:**

```json
{
  "error": "INVALID_EMAIL",
  "message": "Некорректный формат email адреса",
  "field": "email"
}
```

**422 Unprocessable Entity - слишком короткий пароль:**

```json
{
  "error": "PASSWORD_TOO_SHORT",
  "message": "Пароль должен содержать минимум 6 символов",
  "field": "password"
}
```

**429 Too Many Requests:**

```json
{
  "error": "RATE_LIMIT_EXCEEDED",
  "message": "Слишком много попыток регистрации. Попробуйте через несколько минут",
  "retryAfter": 300
}
```

## Безопасность и ограничения

### Защита от атак

- **Rate Limiting**: ограничение до 5 попыток регистрации в минуту с одного IP адреса
- **Password Security**: хеширование паролей с bcrypt и солью (12 раундов)
- **Input Validation**: строгая валидация всех входящих данных
- **SQL Injection Prevention**: использование параметризованных запросов

### Аудит и логирование

- Логирование всех попыток регистрации (успешных и неудачных)
- Сохранение IP адреса и User-Agent для анализа безопасности
- Мониторинг подозрительной активности (множественные регистрации с одного IP)

### Ограничения

- Максимальная длина email: 255 символов
- Максимальная длина пароля: 128 символов
- Максимальная длина имени и фамилии: 50 символов каждое
- Email адрес должен быть уникальным в системе
- Не поддерживается массовая регистрация пользователей

## Интеграция с другими компонентами

### База данных

- Создание записи в таблице `user`
- Создание записи в таблице `user_role` с ролью `USER`
- Использование транзакций для обеспечения целостности данных

### Зависимости

- **PostgreSQL**: для сохранения данных пользователя
- **bcrypt**: для безопасного хеширования паролей
- **UUID Generator**: для генерации уникальных идентификаторов

### Связь с другими API

**После регистрации пользователь может:**

- Использовать **[`POST /api/login`](POST_login.md)** для аутентификации
- Получить JWT токены для доступа к защищенным ресурсам
- Обновить свой профиль через `PUT /api/auth/profile`

## Тестирование

### Позитивные сценарии

- Регистрация с валидными email и паролем
- Проверка создания записей в базе данных
- Проверка корректного хеширования пароля
- Назначение роли `USER` новому пользователю

### Негативные сценарии

- Попытка регистрации с уже существующим email
- Регистрация с некорректным форматом email
- Попытка регистрации с пустым или слишком коротким паролем
- Превышение rate limit для регистрации
- Проверка обработки ошибок базы данных

### Нагрузочное тестирование

- Одновременная регистрация множества пользователей
- Проверка производительности при высокой нагрузке
- Тестирование rate limiting механизмов